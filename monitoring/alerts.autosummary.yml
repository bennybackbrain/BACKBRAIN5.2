groups:
- name: autosummary.rules
  rules:
  # Recording
  - record: job:bb_auto_summary_ok_rate:5m
    expr: rate(bb_auto_summary_total{status="ok"}[5m])
  - record: job:bb_auto_summary_err_rate:5m
    expr: rate(bb_auto_summary_total{status="error"}[5m])
  - record: job:bb_auto_summary_err_ratio:5m
    expr: job:bb_auto_summary_err_rate:5m
         / ignoring(status)
         (job:bb_auto_summary_ok_rate:5m + job:bb_auto_summary_err_rate:5m)
  - record: job:bb_auto_summary_p95_seconds:5m
    expr: histogram_quantile(0.95,
          rate(bb_auto_summary_duration_seconds_bucket[5m]))

  # Alerts
  - alert: AutoSummaryHighErrorRatio
    expr: job:bb_auto_summary_err_ratio:5m > 0.05
    for: 10m
    labels: { severity: warning }
    annotations:
      summary: "Auto-summary error ratio > 5% (10m)"
      description: "Check logs and WebDAV/local fallback."

  - alert: AutoSummaryTooSlow
    expr: job:bb_auto_summary_p95_seconds:5m > 3
    for: 10m
    labels: { severity: warning }
    annotations:
      summary: "Auto-summary p95 latency > 3s (10m)"
      description: "Investigate model latency / storage slowness."

  - alert: AutoSummaryNoActivity
    expr: sum(rate(bb_auto_summary_total[30m])) == 0
    for: 30m
    labels: { severity: info }
    annotations:
      summary: "No auto-summary activity (30m)"
      description: "Might be off-hours; verify writes are still coming."
